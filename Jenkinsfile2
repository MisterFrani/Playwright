pipeline {
    //installer l'environnement
    //nodesjs, playwright
    agent {
        docker {
            //image 'playwright/chromium:playwright-1.56.1'
            image 'mcr.microsoft.com/playwright:v1.57.0-noble'
        
            args '--user=root --entrypoint=""'
        }
    }

    parameters {
        choice(
            name: 'browser',
            choices: ['chromium', 'firefox', 'webkit'],
            description: 'Select the browser to run tests on'
        )
    }

    stages {
        stage('démarrage de configuration projet') {
            steps {
                //supprimer le fichier repo
                sh 'rm -rf repo2'
            }
        }

        /*
        stage("préparation de l'environnement") {
            steps {
                // installer git (nécessaire pour le clone)
                sh 'apt-get update && apt-get install -y git'
            }
        }
        */

        stage('clone du projet') {
            steps {
                //cloner l'adresse git du projet
                sh 'git clone https://github.com/MisterFrani/Playwright.git repo2'
                // installer les dépendances dans le dossier repo
                dir('repo2') {
                    sh 'npm install'
                    sh 'npx playwright install'
                }
            }
        }
        stage(' verification des versions ') {
            steps {
                //check version de node et playwright
                sh 'node --version'
                dir('repo2') {
                    sh 'npx playwright --version'
                }
            }
        }
        stage('test E2E') {
            steps {
                //acceder au projet repo avec la commannde dir
                dir('repo2') {
                    script {
                        if (params.browser == 'chromium') {
                            echo 'Running tests on Chromium'
                            sh "npx playwright test loginpom --project=${params.browser} --grep '@regression'"
                        }   else if (params.browser == 'firefox') {
                            echo 'Running tests on firefox'
                        }   else{
                            echo 'Running tests on webkit'
                        }
                    }
                }
            }
        }
        
    }

}
